/*
*
*	Ritorna la tara dei prodotti di un ddt, in base a @iDocUniq
*
*/
CREATE FUNCTION [dbo].[udfCliDoc_Tara_Pers]
(
	@iDocUniq int
)
RETURNS decimal(9, 3)
AS
BEGIN
Declare @dTara decimal(9, 3) = 0
/* PRIMA PERSONALIZZAZIONE (Modificata su richiesta)
Select @dTara = Sum(Tara) From (Select A.UniqLin, 
(IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '12') As decimal(9, 3)),0) *
IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '13') As int),0)) +
(IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '22') As decimal(9, 3)),0) *
IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '23') As int),0)) +
(IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '32') As decimal(9, 3)),0) *
IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '33') As int),0)) +
(IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '42') As decimal(9, 3)),0) *
IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '43') As int),0)) +
(IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '52') As decimal(9, 3)),0) *
IsNull(Try_Cast((Select IsNull(B.ParValue,0) From [CliDocLinPar] B Where B.UniqLin = A.UniqLin And ParLin = '53') As int),0)) Tara
From [CliDocLinPar] A Where UniqDoc = @iDocUniq Group By A.UniqLin) C
*/

Select @dTara = Sum(IsNull(C.Peso,0) * IsNull(B.LinRif,0)) From PrdAna A 
Join CliDOcLin B On A.PrdCod = B.PrdCod
Join PrdFormTabLinEx_Pers C On C.TabCod = 'IMBALLI' And A.Tab2 = C.ItemID
Where B.UniqDoc = @iDocUniq

Set @dTara = IsNull(@dTara, 0)

RETURN @dTara
END