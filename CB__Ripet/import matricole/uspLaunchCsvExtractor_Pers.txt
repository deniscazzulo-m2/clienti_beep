/*
*
* Estrapolazione contenuto CSV per inserire i prezzi di vendita
*
*/
CREATE PROCEDURE [uspLaunchCsvExtractor_Pers]
	@iSessionID int
	, @sFilePath varchar(255)
AS
SET NOCOUNT ON

Declare @bOk bit
Declare @sMsg varchar(1024)
Declare @sCmd varchar(2000)
Declare @sRow varchar(1024)
Declare @sPrdCod varchar(32)
Declare @sPrdSerial varchar(32)
Declare @iPrdSerialID  decimal(13)
Declare @iItemLast decimal(13) 
Declare @tbFileBody Table(
	[Linea] varchar(1024),
	[UniqRow] int IDENTITY
)
Declare @tbExtracted Table(
	[PrdSerialID] decimal(13),
	[PrdCod] varchar(32),
	[PrdSerial] varchar(32),
	[UniqRow] int IDENTITY
)

Set @sFilePath = RTrim(LTrim(IsNull(@sFilePath, '')))

Set @bOk = 1
Set @sMsg = 'OK'

Set @sCmd = 'type "' + @sFilePath + '"'

Insert Into @tbFileBody(Linea)
Exec [master].dbo.[xp_cmdshell] @sCmd

Delete From @tbFileBody Where Len(RTrim(LTrim(IsNull(Linea, '')))) = 0

If (select Count(1) From @tbFileBody) > 0
Begin
	-- ESTRAGGO RIGHE CSV
	Declare cCursorRows Cursor FAST_FORWARD For
	Select RTrim(LTrim(Linea)) MyRow
	From @tbFileBody 
	Order By UniqRow ASC

	Open cCursorRows
	Fetch Next From cCursorRows Into @sRow
	While (@@Fetch_Status <> -1 And @bOk = 1)
	Begin

		Select @sPrdCod = LTrim(RTrim(IsNull(Token, ''))) From dbo.[udfStrSplit] (@sRow, ';') Where Pos = 0
		Select @sPrdSerial = LTrim(RTrim(IsNull(Token, ''))) From dbo.[udfStrSplit] (@sRow, ';') Where Pos = 1

		If((Select Top 1 1 From [PrdAna] Where Lower(PrdCod) = Lower(@sPrdCod)) = 1 And Len(@sPrdSerial) > 0)
		Begin
			Execute dbo.[uspNumUniqNext_out] 'PrdSerial', @iPrdSerialID OUTPUT
			Insert Into @tbExtracted (PrdSerialID, PrdCod, PrdSerial) Values (@iPrdSerialID, @sPrdCod, @sPrdSerial )
		End
		Else
		Begin
			Set @bOk = 0
			Set @sMsg = 'Errore nel corpo del file: Codice prodotto non trovato o matricola assente'
		End
		-----------------------------------
		Fetch Next From cCursorRows Into @sRow
	End
	Close cCursorRows
	Deallocate cCursorRows

	-- INSERISCO NUOVI DATI
	If IsNull((Select Top 1 1 From dbo.[PrdSerialAna] A Join @tbExtracted B On A.PrdCod = B.PrdCod And A.PrdSerial = B.PrdSerial), 0) <> 1
	Begin
		Insert Into dbo.[PrdSerialAna] (PrdSerialID, PrdCod, PrdSerial, ItemStatus, ItemDta)
		Select PrdSerialID, PrdCod, PrdSerial, '1', CONVERT (date, GETDATE()) From @tbExtracted
		
	-- RIMUOVO FILE TEMPORANEO
		Set @sCmd = 'del "' + @sFilePath + '" /Q'
		EXEC [master].dbo.[xp_cmdshell] @sCmd, NO_OUTPUT
	End
	Else
	Begin
		Set @iItemLast = 0
		Select @iItemLast = Max(PrdSerialID) From dbo.[PrdSerialAna]
		Execute dbo.[uspNumUniqUpdate] 'PrdSerial', @iItemLast
		Set @bOk = 0
		Set @sMsg = 'Errore nel corpo del file: Coppia prodotto-matricola gi√† esistente'
	End

End
Else
Begin
	Set @bOk = 0
	Set @sMsg = 'Errore nel corpo del file: Nessun dato valido rilevato'
End

Select @sMsg