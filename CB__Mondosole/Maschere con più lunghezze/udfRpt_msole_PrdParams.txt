/*
*	Per uso in report:
*
*	PERSONALIZZATA -- RITORNA SOLTANTO L/H (ParID 1/2)
*	
*/
CREATE FUNCTION [udfRpt_msole_PrdParams]
(
	@iDocTip tinyint,
	@iUniqLin int
)
RETURNS varchar(1024)
AS
BEGIN
Declare @sTableID varchar(32)
Declare @sParams varchar(4096) = ''

Declare @iParID int
Declare @dParValue decimal(19,6)

Declare @iParStart int = 1
Declare @iParEnd int = 2

Set @sTableID = dbo.[udfDocTip_TableID](@iDocTip)

If @sTableID = 'CliDoc'
-- [CliDoc] [CliDocPar] [CliDocLin] [CliDocLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[CliDocLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'CliOff'
-- [CliOff] [CliOffPar] [CliOffLin] [CliOffLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[CliOffLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'CliOrd'
-- [CliOrd] [CliOrdPar] [CliOrdLin] [CliOrdLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[CliOrdLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'ForDoc'
-- [ForDoc] [ForDocPar] [ForDocLin] [ForDocLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[ForDocLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'ForOff'
-- [ForOff] [ForOffPar] [ForOffLin] [ForOffLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[ForOffLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'ForOrd'
-- [ForOrd] [ForOrdPar] [ForOrdLin] [ForOrdLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[ForOrdLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else If @sTableID = 'BasketDoc'
-- [ForOrd] [ForOrdPar] [ForOrdLin] [ForOrdLinPar]
Begin
	Declare [cCursor] Cursor LOCAL FAST_FORWARD For
	Select Min(ParID) ParID, Sum(Cast((Case When IsNumeric(IsNull(ParValue,'')) = 1 Then ParValue Else '0' End) as decimal(19,6))) Y
	From dbo.[BasketDocLinPar]
	Where UniqLin = @iUniqLin
		And ((ParID Between @iParStart And @iParEnd)
		Or (Lower(FormCod) Like 'zld%' And IsNumeric(IsNull(ParValue,'')) = 1 And Lower(ParDes) Like '%larg%'))
	Group By (Case When Lower(ParDes) Like '%larg%' Then 'larg' Else 'altro' End)
	Order By ParID
End
Else
Begin
	Set @sTableID = ''
End


If @sTableID <> ''
BEGIN
	Declare @dValue decimal(19, 6)

	Open [cCursor]
	Fetch Next From [cCursor] Into @iParID, @dParValue
	While (@@Fetch_Status <> -1)
		Begin
			Set @iParID = IsNull(@iParID, 0)
			Set @dParValue = IsNull(@dParValue, 0)
		
			If @dParValue <> 0
			Begin				
				Set @sParams = @sParams + ' ' + dbo.[udfRpt_Format](@dParValue, '1')	
			End			
			Fetch Next From [cCursor] Into @iParID, @dParValue
		End
	Close [cCursor]
	Deallocate [cCursor]

	Set @sParams = IsNull(@sParams, '')	
		
	If @sParams <> ''
	Begin
		Set @sParams = LTrim(RTrim(@sParams))
		Set @sParams = Replace(@sParams, ' ', ' x ')
	End
END

	RETURN @sParams
END